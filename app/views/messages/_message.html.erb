<% inside_thread = local_assigns.fetch(:inside_thread, false) %>

<turbo-frame id="message_<%= message.id %>">
  <div class="group flex items-start space-x-3 p-3 hover:bg-gray-100 rounded-lg transition-colors duration-150"
       id="message-<%= message.id %>"
       data-message-id="<%= message.id %>">

    <!-- Avatar -->
    <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-medium shadow-sm">
      <%= message.user.email.first.upcase %>
    </div>

    <!-- Message Content -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center space-x-2 mb-1">
        <span class="text-sm font-semibold text-gray-900"><%= message.user.email %></span>
        <span class="text-xs text-gray-400"><%= message.created_at.strftime("%H:%M") %></span>
        <% if message.updated_at != message.created_at %>
          <span class="text-xs text-gray-400">(edited)</span>
        <% end %>
      </div>

      <div class="text-sm text-gray-800 leading-relaxed">
        <%= message.body %>
      </div>
    </div>

    <!-- Actions (Visible on hover) -->
    <% unless inside_thread %>
      <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
        <!-- View Thread -->
        <%= link_to workspace_channel_message_path(message.channel.workspace, message.channel, message),
                    data: { turbo_frame: "message_thread" },
                    onclick: "document.getElementById('message_thread').classList.remove('hidden')",
                    class: "p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-150" do %>
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        <% end %>

        <!-- Edit (only for message owner) -->
        <% current_user = local_assigns.fetch(:current_user, defined?(current_user) ? current_user : nil) %>
        <% if current_user && message.user == current_user %>

          <!-- Delete (only for message owner) -->
          <%= button_to workspace_channel_message_path(message.channel.workspace, message.channel, message),
                        method: :delete,
                        data: { confirm: "Are you sure you want to delete this message?" },
                        class: "p-2 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-150" do %>
            <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</turbo-frame>